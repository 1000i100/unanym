<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <title data-replace="title">Vote Anonyme</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div class="container">
            <h1 data-replace="title">Titre du vote</h1>

            <!-- Section pour vote nul -->
            <div data-show-if="contested=1" class="contested">
                <p>Vote nul : erreur ou triche au nombre de votes.</p>
                <p>
                    Nouveau vote créé :
                    <a href="#new_vote_id" data-replace="new_vote_id"
                        >Accéder au nouveau vote</a
                    >
                </p>
            </div>

            <!-- Section pour vote clos avec résultats -->
            <div data-show-if="state=closed" class="closed">
                <div data-show-if="show_results=1" class="result">
                    <h2>
                        <span data-replace="is_unanimous"></span>
                        <span data-replace="result_label"></span>
                    </h2>
                </div>
                <div data-hide-if="show_results=1" class="result-waiting">
                    <p>
                        Ce vote est clos. Le résultat sera visible après le
                        délai de contestation.
                    </p>
                    <button type="button" id="contest-button">
                        Contester : j'aurais dû pouvoir voter
                    </button>
                    <p>
                        Délai de contestation :
                        <span data-replace="contestation_duration"></span>
                    </p>
                </div>
            </div>

            <!-- Section pour vote en cours -->
            <div data-show-if="state=open" class="open">
                <p>
                    <strong data-replace="votes_received"></strong> sur
                    <strong data-replace="total_voters"></strong> attendus.
                </p>
                <form id="vote-form" data-show-if="state=open">
                    <label class="radio-button active">
                        <input
                            type="radio"
                            name="choice"
                            value="unanimous"
                            required
                        />
                        <span data-replace="choice_unanimous"></span>
                    </label>
                    <label class="radio-button">
                        <input
                            type="radio"
                            name="choice"
                            value="veto"
                            required
                        />
                        <span data-replace="choice_veto"></span>
                    </label>
                    <button type="submit">Valider mon vote</button>
                </form>
            </div>
        </div>
        <script>
            // Fonction pour parser le hash de l'URL
            function getHashParams() {
                const hash = location.hash.replace(/^#/, "");
                return Object.fromEntries(new URLSearchParams(hash));
            }

            // Paramètres par défaut
            const defaultState = {
                state: "open",
                title: "Vote de Test",
                votes_received: 0,
                total_voters: 5,
                choice_unanimous: "Choix A",
                choice_veto: "Choix B",
                contestation_duration: "7 days",
                show_results_immediately: 1,
                contested: 1,
                new_vote_id: "abc123",
            };

            // Applique les données au template
            function applyTemplate(data) {
                document.querySelectorAll("[data-replace]").forEach((el) => {
                    const key = el.getAttribute("data-replace");
                    el.textContent = data[key] || "";
                });

                document.querySelectorAll("[data-show-if]").forEach((el) => {
                    const condition = el.getAttribute("data-show-if");
                    const [key, value] = condition.split("=");
                    el.style.display = data[key] === value ? "" : "none";
                });

                document.querySelectorAll("[data-hide-if]").forEach((el) => {
                    const condition = el.getAttribute("data-hide-if");
                    const [key, value] = condition.split("=");
                    el.style.display = data[key] === value ? "none" : "";
                });

                // Gestion du résultat unanime/veto
                const resultLabel = document.getElementById("result-label");
                if (resultLabel) {
                    resultLabel.textContent =
                        data.votes_received == data.total_voters
                            ? "✅ Unanimité"
                            : "❌ Véto";
                }
            }

            // Calcul de la date de fin de contestation
            function calculateContestationEnd(duration) {
                const now = new Date();
                switch (duration) {
                    case "5 minutes":
                        return new Date(now.getTime() + 5 * 60000);
                    case "1 hour":
                        return new Date(now.getTime() + 60 * 60000);
                    case "1 day":
                        return new Date(now.getTime() + 24 * 3600000);
                    case "7 days":
                        return new Date(now.getTime() + 7 * 86400000);
                    case "15 days":
                        return new Date(now.getTime() + 15 * 86400000);
                    case "1 month":
                        return new Date(now.setMonth(now.getMonth() + 1));
                    case "1 year":
                        return new Date(now.setFullYear(now.getFullYear() + 1));
                    default:
                        return null;
                }
            }

            // Initialisation
            window.addEventListener("load", () => {
                const params = getHashParams();
                const state = {
                    ...defaultState,
                    ...params,
                };

                // Simule contestation_end
                if (
                    state.state === "closed" &&
                    !state.show_results_immediately &&
                    state.contestation_duration !== "none"
                ) {
                    const contestationEnd = calculateContestationEnd(
                        state.contestation_duration,
                    );
                    state.contestation_end = contestationEnd
                        ? contestationEnd.toISOString()
                        : null;
                    state.can_contest = contestationEnd
                        ? new Date() < contestationEnd
                        : false;
                    state.show_results =
                        state.show_results_immediately == 1 ||
                        !state.can_contest;
                }

                // Simulation de isUnanimous
                state.is_unanimous =
                    state.votes_received == state.total_voters ? "✅" : "❌";
                state.result_label =
                    state.votes_received == state.total_voters
                        ? "Unanimité"
                        : "Véto";
                state.choice =
                    state.votes_received == state.total_voters
                        ? state.choice_unanimous
                        : state.choice_veto;

                // Met à jour la page
                applyTemplate(state);
            });
        </script>
    </body>
</html>
